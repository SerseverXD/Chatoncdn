<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Realtime Chat</title>

<!-- Icons -->
<link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css" />

<style>
  :root {
    --bg:#f5f5f5;--text:#111;--bubble-me:#daf8cb;--bubble-them:#fff;
    --input-bg:#fff;--border:#ddd;--name:#555;
    --accent: #4285F4; /* Google Blue */
  }
  [data-theme="dark"] {
    --bg:#0f0f0f;--text:#e9e9e9;--bubble-me:#005c4b;--bubble-them:#1f1f1f;
    --input-bg:#1a1a1a;--border:#333;--name:#aaa;
  }
  *{box-sizing:border-box;font-family:system-ui,sans-serif;margin:0;padding:0}

  body{background:var(--bg);color:var(--text);display:flex;justify-content:center;align-items:center;height:100dvh;overflow:hidden;}

  /* Main chat container visibility is controlled by JS based on Auth status */
  #mainApp { display: none; }

  .chat-container{width:100%;max-width:480px;height:100%;display:flex;flex-direction:column;border-left:1px solid var(--border);border-right:1px solid var(--border);background:var(--bg);}

  .header{padding:12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);font-weight:600;flex-shrink:0}

  .messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}

  .bubble{padding:10px 14px;max-width:75%;border-radius:16px;font-size:15px;line-height:1.3;word-break:break-word;position:relative;cursor:pointer;transition:transform 0.2s;}
  /* Swipe for reply effect */
  .bubble:active { transform: translateX(15px); }
  
  .me{align-self:flex-end;background:var(--bubble-me);border-bottom-right-radius:4px}
  .them{align-self:flex-start;background:var(--bubble-them);border-bottom-left-radius:4px}

  .user-info{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
  .name{font-size:12px;font-weight:600;color:var(--name);}

  /* Avatar Styling */
  .avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px; /* For emoji */
    background: #ccc;
    flex-shrink: 0;
  }

  /* Reply Container Style */
  .reply-container {
    padding: 8px;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.05);
    border-left: 4px solid #66b3ff;
    margin-bottom: 6px;
    font-size: 13px;
    max-height: 40px;
    overflow: hidden;
    color: var(--name);
  }
  .reply-container strong {
    font-weight: 700;
    font-size: 14px;
    color: var(--text);
    display: block;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .input-bar{display:flex;flex-direction:column;padding:10px;gap:8px;border-top:1px solid var(--border);background:var(--input-bg);flex-shrink:0;position:sticky;bottom:0}

  /* Reply Preview Bar */
  .reply-preview {
    display: none; /* Controlled by JS */
    align-items: center;
    padding: 8px 12px;
    background: var(--bubble-them);
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid var(--border);
    max-height: 50px;
    overflow: hidden;
  }
  .reply-info {
    flex-grow: 1;
    border-left: 3px solid #66b3ff;
    padding-left: 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 14px;
  }
  .reply-info strong {
    display: block;
    font-weight: 700;
    color: var(--text);
  }
  .reply-cancel-btn {
    font-size: 18px;
    cursor: pointer;
    color: var(--name);
    margin-left: 10px;
    padding: 0 4px;
  }

  .input-fields{display:flex;gap:8px;}

  input{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:20px;font-size:15px;background:var(--input-bg);color:var(--text);}
  input:focus{outline:none;border-color:#888}

  button{border:none;background:none;font-size:22px;cursor:pointer;color:var(--text)}

  .toggle{width:46px;height:26px;background:var(--border);border-radius:20px;position:relative;cursor:pointer;transition:.2s}
  .toggle::after{content:"";width:22px;height:22px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:.2s}
  [data-theme="dark"] .toggle{background:#4b4b4b}
  [data-theme="dark"] .toggle::after{transform:translateX(20px)}

  /* modal styles */
  .modal-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:1000;
  }
  .modal-box{
    background:var(--bg);padding:20px;border-radius:12px;width:90%;max-width:380px;display:flex;flex-direction:column;gap:15px;border:1px solid var(--border);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  .modal-box input, .modal-box button{border-radius:8px;padding:10px 12px;font-size:16px;}
  .modal-box button{background:var(--accent);color:white;font-weight:600;border:none;cursor:pointer;transition:background 0.2s;}
  .modal-box button:hover{background: #3c7ce8;}
  
  /* Auth Tabs */
  .tab-bar { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
  .tab-bar button { flex: 1; padding: 10px 0; border: none; background: none; color: var(--name); font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; }
  .tab-bar button.active { color: var(--text); border-bottom-color: var(--accent); }

  .auth-section { display: none; flex-direction: column; gap: 15px; }
  .auth-section.active { display: flex; }

  .google-btn {
    background: white;
    color: #444;
    border: 1px solid #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 14px;
  }
  .google-btn:hover { background: #f8f8f8; }
  .google-icon { width: 18px; height: 18px; }

  .error-message { color: #E74C3C; font-size: 14px; text-align: center; font-weight: 600; }
  
  #userProfile {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  #logoutBtn {
    color: #E74C3C;
    font-size: 18px;
    padding: 0;
    transition: opacity 0.2s;
  }
  #logoutBtn:hover {
    opacity: 0.8;
  }
</style>
</head>
<body>

<div id="mainApp" class="chat-container">
  <div class="header">
    <span id="chatTitle">Realtime Chat</span>
    <div id="userProfile">
      <!-- Profile image and user name will go here -->
    </div>
    <div style="display:flex;gap:12px;align-items:center">
      <i id="logoutBtn" class="uil uil-sign-out-alt" title="Logout"></i>
      <div id="themeToggle" class="toggle"></div>
    </div>
  </div>

  <div id="messages" class="messages"></div>

  <div id="inputBar" class="input-bar">
    <div id="replyPreview" class="reply-preview">
        <div id="replyInfo" class="reply-info"></div>
        <i id="replyCancelBtn" class="uil uil-multiply reply-cancel-btn"></i>
    </div>
    <div class="input-fields">
        <input id="msgInput" type="text" placeholder="Type a message..." autocomplete="off" />
        <button id="sendBtn"><i class="uil uil-location-arrow"></i></button>
    </div>
  </div>
</div>

<!-- Authentication Modal -->
<div id="authModal" class="modal-overlay">
  <div class="modal-box">
    <div class="tab-bar">
      <button id="loginTabBtn" class="active">Accedi</button>
      <button id="signupTabBtn">Registrati</button>
    </div>

    <div id="loginSection" class="auth-section active">
      <input id="loginEmail" type="email" placeholder="Email" />
      <input id="loginPassword" type="password" placeholder="Password" />
      <p id="loginError" class="error-message" style="display:none"></p>
      <button id="emailLoginBtn">Accedi con Email</button>
      <button id="googleLoginBtn" class="google-btn">
        <img class="google-icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/512px-Google_%22G%22_logo.svg.png" alt="Google logo"/>
        Accedi con Google
      </button>
    </div>

    <div id="signupSection" class="auth-section">
      <input id="signupUsername" type="text" placeholder="Nome Utente (per Email/Password)" />
      <input id="signupEmail" type="email" placeholder="Email" />
      <input id="signupPassword" type="password" placeholder="Password (min. 6 caratteri)" />
      <p id="signupError" class="error-message" style="display:none"></p>
      <button id="emailSignupBtn">Registrati con Email</button>
      <button id="googleSignupBtn" class="google-btn">
        <img class="google-icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/512px-Google_%22G%22_logo.svg.png" alt="Google logo"/>
        Registrati con Google
      </button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { 
  getDatabase, ref, push, onValue, set, get 
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  GoogleAuthProvider, 
  signInWithPopup, 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  updateProfile
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

// Firebase config (The original config is kept)
const firebaseConfig = {
  apiKey: "AIzaSyAyKbYd-nB-n38Dz1ZgHjvu7ZKz8--nz6Y",
  authDomain: "chatapponrecdn.firebaseapp.com",
  projectId: "chatapponrecdn",
  storageBucket: "chatapponrecdn.firebasestorage.app",
  messagingSenderId: "789338096101",
  appId: "1:789338096101:web:d281570388fbc63a866f0c",
  measurementId: "G-5HMKRXWCPZ",
  databaseURL: "https://chatapponrecdn-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const messagesRef = ref(db, "messages");
const usersRef = ref(db, "users");

let user = null; // Firebase User object
let replyingTo = null; 

// Emojis for Email/Password users
const EMOJI_AVATARS = ["ðŸ˜€", "ðŸ˜", "ðŸ˜‚", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜…", "ðŸ˜†", "ðŸ˜‡", "ðŸ˜ˆ", "ðŸ˜‰", "ðŸ˜Š", "ðŸ˜‹", "ðŸ˜Œ", "ðŸ˜", "ðŸ˜Ž", "ðŸ˜", "ðŸ˜", "ðŸ˜‘", "ðŸ˜’", "ðŸ™„", "ðŸ¤ ", "ðŸ¤©", "ðŸ¥³", "ðŸ¤¯", "ðŸ¤ª", "ðŸ¥º"];
const DEFAULT_AVATAR = "ðŸ‘¤"; // Fallback/default emoji

/**
 * Returns a random emoji from the predefined list.
 * @returns {string} Random emoji.
 */
function getRandomEmoji() {
  return EMOJI_AVATARS[Math.floor(Math.random() * EMOJI_AVATARS.length)];
}

/**
 * Ensures the user has a profile picture (URL or Emoji).
 * If the user is Email/Password and lacks a photoURL, a random emoji is generated and stored.
 * @param {object} currentUser - The Firebase User object.
 * @param {string} username - The display name provided by the user (only for sign-up).
 */
async function ensureUserProfile(currentUser, username = null) {
  const userNodeRef = ref(db, `users/${currentUser.uid}`);
  
  if (currentUser.photoURL) {
    // Google user - photoURL is ready
    await set(userNodeRef, {
      displayName: currentUser.displayName,
      photoURL: currentUser.photoURL,
    });
    return { name: currentUser.displayName, avatar: currentUser.photoURL };
  } 

  // Check if we already have the user data in Realtime DB
  const snapshot = await get(userNodeRef);
  if (snapshot.exists() && snapshot.val().avatar) {
    return { name: snapshot.val().displayName, avatar: snapshot.val().avatar };
  }
  
  // Email/Password user (or first-time Google sign-in without a name)
  let name = currentUser.displayName || username || "Chat User";
  let avatar = getRandomEmoji();

  // If new registration via Email/Password, update Firebase Auth profile too
  if (!currentUser.displayName && username) {
     await updateProfile(currentUser, { displayName: name });
  }

  // Store the generated avatar and name in Realtime DB
  await set(userNodeRef, {
    displayName: name,
    avatar: avatar,
  });

  return { name, avatar };
}

// --- DOM ELEMENTS ---
const mainApp = document.getElementById("mainApp");
const authModal = document.getElementById("authModal");

const loginTabBtn = document.getElementById("loginTabBtn");
const signupTabBtn = document.getElementById("signupTabBtn");
const loginSection = document.getElementById("loginSection");
const signupSection = document.getElementById("signupSection");

const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const loginError = document.getElementById("loginError");
const emailLoginBtn = document.getElementById("emailLoginBtn");
const googleLoginBtn = document.getElementById("googleLoginBtn");

const signupUsername = document.getElementById("signupUsername");
const signupEmail = document.getElementById("signupEmail");
const signupPassword = document.getElementById("signupPassword");
const signupError = document.getElementById("signupError");
const emailSignupBtn = document.getElementById("emailSignupBtn");
const googleSignupBtn = document.getElementById("googleSignupBtn");

const messagesBox = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const logoutBtn = document.getElementById("logoutBtn");

const userProfileDiv = document.getElementById("userProfile");
const replyPreview = document.getElementById("replyPreview");
const replyInfo = document.getElementById("replyInfo");
const replyCancelBtn = document.getElementById("replyCancelBtn");

// --- UTILITY FUNCTIONS ---

function showAuthError(element, message) {
  element.textContent = message;
  element.style.display = "block";
}

function clearAuthErrors() {
  loginError.style.display = "none";
  signupError.style.display = "none";
}

function handleAuthError(error, errorElement) {
  let message;
  switch (error.code) {
    case 'auth/user-not-found':
    case 'auth/wrong-password':
      message = "Email o password non validi.";
      break;
    case 'auth/email-already-in-use':
      message = "Questa email Ã¨ giÃ  registrata.";
      break;
    case 'auth/weak-password':
      message = "La password deve essere lunga almeno 6 caratteri.";
      break;
    case 'auth/invalid-email':
      message = "Formato email non valido.";
      break;
    default:
      console.error(error);
      message = `Errore di autenticazione: ${error.message}`;
  }
  showAuthError(errorElement, message);
}

// --- AUTH LOGIC ---

// Tab switching
loginTabBtn.onclick = () => {
  loginTabBtn.classList.add("active");
  signupTabBtn.classList.remove("active");
  loginSection.classList.add("active");
  signupSection.classList.remove("active");
  clearAuthErrors();
};

signupTabBtn.onclick = () => {
  signupTabBtn.classList.add("active");
  loginTabBtn.classList.remove("active");
  signupSection.classList.add("active");
  loginSection.classList.remove("active");
  clearAuthErrors();
};

// Google Auth
const provider = new GoogleAuthProvider();
async function handleGoogleAuth(errorElement) {
  clearAuthErrors();
  try {
    const result = await signInWithPopup(auth, provider);
    // User signed in successfully, onAuthStateChanged handles the rest
  } catch (error) {
    handleAuthError(error, errorElement);
  }
}
googleLoginBtn.onclick = () => handleGoogleAuth(loginError);
googleSignupBtn.onclick = () => handleGoogleAuth(signupError);

// Email/Password Sign Up
emailSignupBtn.onclick = async () => {
  const name = signupUsername.value.trim();
  const email = signupEmail.value.trim();
  const password = signupPassword.value.trim();

  if (!name) return showAuthError(signupError, "Inserisci un nome utente.");

  clearAuthErrors();
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    
    // Store profile data (name and generated emoji) in DB
    await ensureUserProfile(user, name); 
    // onAuthStateChanged handles UI update
  } catch (error) {
    handleAuthError(error, signupError);
  }
};

// Email/Password Login
emailLoginBtn.onclick = async () => {
  const email = loginEmail.value.trim();
  const password = loginPassword.value.trim();

  clearAuthErrors();
  try {
    await signInWithEmailAndPassword(auth, email, password);
    // onAuthStateChanged handles UI update
  } catch (error) {
    handleAuthError(error, loginError);
  }
};

// Logout
logoutBtn.onclick = () => {
  signOut(auth);
};

// --- AUTH STATE CHANGE HANDLER (The core of the app) ---
onAuthStateChanged(auth, async (currentUser) => {
  if (currentUser) {
    // User is signed in
    user = currentUser;
    authModal.style.display = "none";
    mainApp.style.display = "flex";

    // 1. Ensure user profile data is ready (name, avatar, or generated emoji)
    const { name, avatar } = await ensureUserProfile(user);

    // 2. Update the global user object with the complete data
    user.displayName = name;
    user.photoURL = avatar;

    // 3. Update header profile icon
    userProfileDiv.innerHTML = `
        ${avatar.startsWith('http') ? 
          `<img src="${avatar}" alt="Avatar" class="avatar" />` : 
          `<span class="avatar">${avatar}</span>`
        }
        <span class="name">${name}</span>
    `;

    // 4. Start listening to messages only when authenticated
    startMessageListener();

  } else {
    // User is signed out
    user = null;
    mainApp.style.display = "none";
    authModal.style.display = "flex";
    messagesBox.innerHTML = ""; // Clear chat on logout
    userProfileDiv.innerHTML = "";
    
    // Stop listening (if listener was active)
    if (unsubscribe) unsubscribe(); 
  }
});

// --- CHAT LOGIC ---

let unsubscribe = null; // Variable to hold the onValue unsubscription function

function startMessageListener() {
    // If a listener already exists, unsubscribe it first
    if (unsubscribe) unsubscribe();

    unsubscribe = onValue(messagesRef, (snapshot) => {
      const data = snapshot.val();
      messagesBox.innerHTML = "";

      if (data) {
        const allMessages = Object.keys(data) 
          .map(key => ({ key, ...data[key] }))
          .sort((a,b) => a.created - b.created);

        allMessages.forEach(d => {
            const wrap = document.createElement("div");
            wrap.className = "bubble " + (d.uid === user.uid ? "me" : "them");
            wrap.dataset.msgKey = d.key; 

            // Reply click handler (simulates swipe)
            wrap.addEventListener('click', () => {
                setReply(d.key, d.username, d.text, d.uid); 
            });

            // Add reply container if message is a reply
            if (d.replyToKey) {
                const replyDiv = document.createElement("div");
                replyDiv.className = "reply-container";
                replyDiv.innerHTML = `<strong>${d.replyToUser}</strong> ${d.replyToText}`;
                wrap.appendChild(replyDiv);
            }

            // User Info (Name + Avatar)
            const userInfoDiv = document.createElement("div");
            userInfoDiv.className = "user-info";

            const avatarNode = document.createElement(d.avatar.startsWith('http') ? 'img' : 'span');
            avatarNode.className = "avatar";
            if (d.avatar.startsWith('http')) {
                avatarNode.src = d.avatar;
            } else {
                avatarNode.textContent = d.avatar;
            }
            
            const nameSpan = document.createElement("span");
            nameSpan.className = "name";
            nameSpan.textContent = d.username || "Unknown";
            
            userInfoDiv.appendChild(avatarNode);
            userInfoDiv.appendChild(nameSpan);
            wrap.appendChild(userInfoDiv);
            
            const contentNode = document.createElement("div");
            contentNode.textContent = d.text || ""; // Insert plain text
            wrap.appendChild(contentNode);

            messagesBox.appendChild(wrap);
        });
      }
      messagesBox.scrollTop = messagesBox.scrollHeight;
    });
}

// Reply feature functions
function setReply(msgKey, username, text, targetUid) {
    if (!user) return; // Must be authenticated to reply
    replyingTo = { key: msgKey, username, text, targetUid }; 
    replyInfo.innerHTML = `<strong>${username}</strong> ${text}`;
    replyPreview.style.display = "flex";
    msgInput.focus();
}

function cancelReply() {
    replyingTo = null;
    replyPreview.style.display = "none";
}

replyCancelBtn.onclick = cancelReply;

function sendMessage() {
  if (!user) return; 

  const text = msgInput.value.trim();
  if (!text) return;

  const messageData = { 
    text, 
    uid: user.uid, 
    username: user.displayName, 
    avatar: user.photoURL, // Photo URL or generated emoji
    created: Date.now(),
  };

  if (replyingTo) {
    messageData.replyToKey = replyingTo.key;
    messageData.replyToUser = replyingTo.username;
    messageData.replyToText = replyingTo.text;
    cancelReply(); 
  }

  push(messagesRef, messageData);
  msgInput.value = "";
}

sendBtn.onclick = sendMessage;
msgInput.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });


// --- THEME TOGGLE (unrelated to auth, kept as requested) ---
const toggle = document.getElementById("themeToggle");
toggle.onclick = () => {
  const dark = document.body.dataset.theme === "dark";
  document.body.dataset.theme = dark ? "" : "dark";
  localStorage.setItem("theme", dark ? "light" : "dark");
};
if (localStorage.getItem("theme") === "dark") document.body.dataset.theme = "dark";
</script>

</body>
</html>

