<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Realtime DB Chat</title>

<link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css" />

<style>
  :root {
    --bg:#f5f5f5;--text:#111;--bubble-me:#daf8cb;--bubble-them:#fff;
    --input-bg:#fff;--border:#ddd;--name:#555;
    --admin-gold: #FFD700;
  }
  [data-theme="dark"] {
    --bg:#0f0f0f;--text:#e9e9e9;--bubble-me:#005c4b;--bubble-them:#1f1f1f;
    --input-bg:#1a1a1a;--border:#333;--name:#aaa;
  }
  *{box-sizing:border-box;font-family:system-ui,sans-serif;margin:0;padding:0}

  body{background:var(--bg);color:var(--text);display:flex;justify-content:center;align-items:center;height:100dvh;overflow:hidden;}

  .chat-container{width:100%;max-width:480px;height:100%;display:flex;flex-direction:column;border-left:1px solid var(--border);border-right:1px solid var(--border);}

  .header{padding:12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);font-weight:600;flex-shrink:0}

  .messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}

  .bubble{padding:10px 14px;max-width:75%;border-radius:16px;font-size:15px;line-height:1.3;word-break:break-word;position:relative;cursor:pointer;transition:transform 0.2s;}
  /* Swipe for reply effect */
  .bubble:active { transform: translateX(15px); }
  
  .me{align-self:flex-end;background:var(--bubble-me);border-bottom-right-radius:4px}
  .them{align-self:flex-start;background:var(--bubble-them);border-bottom-left-radius:4px}
  .gold-text{color:var(--admin-gold);font-weight:700;text-shadow: 1px 1px 1px rgba(0,0,0,0.1)}

  .name{font-size:12px;font-weight:600;margin-bottom:4px;color:var(--name);display:flex;align-items:center;gap:6px;}
  .admin-tag {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 8px;
    font-weight: 700;
    color: white;
  }
  .tag-admin { background: #E74C3C; } /* Red */
  .tag-mod { background: #3498DB; } /* Blue */
  .tag-system { background: #3498DB; } /* Blue for System */

  /* Ad specific styling */
  .ad-content {
      max-width: 100%;
      padding: 0;
      word-break: normal;
  }
  .ad-content iframe {
      max-width: 100%;
      height: 60px !important; /* Fixed height for adaptive ad preview */
      border-radius: 8px;
  }
  /* Stile modificato per evitare che sia in primo piano e il refresh */
  #frame {
      width: 100%;
      margin: auto;
      position: relative; 
      z-index: 1; /* Abbassato z-index per non essere in primo piano */
  }


  /* Reply Container Style */
  .reply-container {
    padding: 8px;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.05);
    border-left: 4px solid #66b3ff;
    margin-bottom: 6px;
    font-size: 13px;
    max-height: 40px;
    overflow: hidden;
    color: var(--name);
  }
  .reply-container strong {
    font-weight: 700;
    font-size: 14px;
    color: var(--text);
    display: block;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .input-bar{display:flex;flex-direction:column;padding:10px;gap:8px;border-top:1px solid var(--border);background:var(--input-bg);flex-shrink:0;position:sticky;bottom:0}

  /* Reply Preview Bar */
  .reply-preview {
    display: none; /* Controlled by JS */
    align-items: center;
    padding: 8px 12px;
    background: var(--bubble-them);
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid var(--border);
    max-height: 50px;
    overflow: hidden;
  }
  .reply-info {
    flex-grow: 1;
    border-left: 3px solid #66b3ff;
    padding-left: 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 14px;
  }
  .reply-info strong {
    display: block;
    font-weight: 700;
    color: var(--text);
  }
  .reply-cancel-btn {
    font-size: 18px;
    cursor: pointer;
    color: var(--name);
    margin-left: 10px;
    padding: 0 4px;
  }

  .input-fields{display:flex;gap:8px;}

  /* Muted Bar Style */
  #mutedNav {
    display: none;
    background: #E74C3C;
    color: white;
    padding: 12px;
    text-align: center;
    font-weight: 600;
    border-radius: 20px;
  }
  /* Show muted nav instead of input fields when muted */
  .input-bar.muted .input-fields, .input-bar.muted .reply-preview { display: none; }
  .input-bar.muted #mutedNav { display: block; }


  input{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:20px;font-size:15px;background:var(--input-bg);color:var(--text);}
  input:focus{outline:none;border-color:#888}

  button{border:none;background:none;font-size:22px;cursor:pointer;color:var(--text)}

  .toggle{width:46px;height:26px;background:var(--border);border-radius:20px;position:relative;cursor:pointer;transition:.2s}
  .toggle::after{content:"";width:22px;height:22px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:.2s}
  [data-theme="dark"] .toggle{background:#4b4b4b}
  [data-theme="dark"] .toggle::after{transform:translateX(20px)}

  /* modal styles */
  .modal-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:center;z-index:1000;
  }
  .modal-box{
    background:var(--bg);padding:20px;border-radius:12px;width:85%;max-width:320px;display:flex;flex-direction:column;gap:12px;border:1px solid var(--border);position:relative;
  }
  .modal-box input{border-radius:8px}
  .modal-box button{font-size:16px;padding:8px 0;border-radius:8px;background:var(--bubble-me);color:var(--text)}
  
  /* Redesigned Close Button */
  .close-btn{
    position:absolute;top:10px;right:10px;
    font-size:24px; /* Larger icon */
    background:none;border:none;cursor:pointer;color:var(--text);
    padding: 0;
    height: 24px;
    width: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-box label { display: block; margin-bottom: 4px; font-size: 14px; }
  .modal-box select { padding: 8px; border-radius: 8px; border: 1px solid var(--border); width: 100%; background: var(--input-bg); color: var(--text); }
  .modal-box p { font-size: 14px; color: var(--name); }
  
  /* Red Admin Button Style */
  #removeAllBtn {
    background: #E74C3C;
    color: white;
    font-size: 16px;
    font-weight: 600;
    margin-top: 10px;
    transition: background 0.2s;
  }
  #removeAllBtn:hover {
    background: #C0392B;
  }

  /* Admin button */
  #adminBtn {
    padding: 6px 10px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 9999px; /* Max rounded corners */
    background: #2ECC71; /* Green color */
    color: white;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
  }
  #adminBtn:hover {
    background: #27AE60;
  }

</style>

<script type="text/javascript">
window._qevents = window._qevents || [];
(function() {
var elem = document.createElement('script');
elem.src = (document.location.protocol == "https:" ? "https://secure" : "http://edge") + ".quantserve.com/quant.js";
elem.async = true;
elem.type = "text/javascript";
var scpt = document.getElementsByTagName('script')[0];
scpt.parentNode.insertBefore(elem, scpt);
})();
window._qevents.push({
qacct:"p-2TpX8KnRnZJah",
uid:"__INSERT_EMAIL_HERE__"
});
</script>
<noscript>
<div style="display:none;">
<img src="//pixel.quantserve.com/pixel/p-2TpX8KnRnZJah.gif" border="0" height="1" width="1" alt="Quantcast"/>
</div>
</noscript>
</head>
<body>

<div class="chat-container">
  <div class="header">
    <span id="chatTitle">Chat</span>
    <div style="display:flex;gap:12px;align-items:center">
      <button id="adminBtn">Become Admin</button>
      <i id="settingsBtn" class="uil uil-setting" style="font-size:22px;cursor:pointer"></i>
      <div id="themeToggle" class="toggle"></div>
    </div>
  </div>

  <div id="messages" class="messages"></div>

  <div id="inputBar" class="input-bar">
    <div id="mutedNav"></div>
    <div id="replyPreview" class="reply-preview">
        <div id="replyInfo" class="reply-info"></div>
        <i id="replyCancelBtn" class="uil uil-multiply reply-cancel-btn"></i>
    </div>
    <div class="input-fields">
        <input id="msgInput" type="text" placeholder="Type a message..." autocomplete="off" />
        <button id="sendBtn"><i class="uil uil-location-arrow"></i></button>
    </div>
  </div>
</div>

<div id="nameModal" class="modal-overlay" style="display:none">
  <div class="modal-box">
    <button class="close-btn" onclick="document.getElementById('nameModal').style.display='none'"><i class="uil uil-multiply"></i></button>
    <h3>Enter your name</h3>
    <input id="nameInput" type="text" placeholder="Your name..." />
    <button id="saveNameBtn">Save</button>
  </div>
</div>

<div id="adminLoginModal" class="modal-overlay" style="display:none">
  <div class="modal-box">
    <button class="close-btn" onclick="document.getElementById('adminLoginModal').style.display='none'"><i class="uil uil-multiply"></i></button>
    <h3>Admin Login</h3>
    <input id="adminUser" type="text" placeholder="Username" />
    <input id="adminPass" type="password" placeholder="Password" />
    <p id="adminLoginError" style="color:red;display:none;font-weight:600;">Invalid credentials</p>
    <button id="loginAdminBtn">Login</button>
  </div>
</div>

<div id="adminPanelModal" class="modal-overlay" style="display:none">
  <div class="modal-box">
    <button class="close-btn" onclick="document.getElementById('adminPanelModal').style.display='none'"><i class="uil uil-multiply"></i></button>
    <h3>Admin Panel</h3>
    
    <label for="chatStyleSelect">Chat Text Style (Self):</label>
    <select id="chatStyleSelect">
      <option value="normal">Normal</option>
      <option value="gold">Gold (Admin Only)</option>
    </select>

    <label for="adminTagSelect">Admin Tag:</label>
    <select id="adminTagSelect">
      <option value="none">None</option>
      <option value="admin">Admin</option>
      <option value="mod">Mod</option>
    </select>
    
    <button id="saveAdminSettingsBtn">Save Settings</button>
    
    <button id="removeAllBtn">Remove All Messages</button>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove, set } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAyKbYd-nB-n38Dz1ZgHjvu7ZKz8--nz6Y",
  authDomain: "chatapponrecdn.firebaseapp.com",
  projectId: "chatapponrecdn",
  storageBucket: "chatapponrecdn.firebasestorage.app",
  messagingSenderId: "789338096101",
  appId: "1:789338096101:web:d281570388fbc63a866f0c",
  measurementId: "G-5HMKRXWCPZ",
  databaseURL: "https://chatapponrecdn-default-rtdb.firebaseio.com"
};

const ADMIN_CREDENTIALS = {
  "Sergio": "Beluga2014%",
  "Alex": "Ale67ForzaInter",
  "Riccardo": "CQrK13H93NS3" 
};

// Bot unique ID
const BOT_UID = "BOT_SYSTEM_BOB_12345";
const BOT_NAME = "Bob";
const BOT_TAG = "system";

// Ad message HTML
const AD_HTML = `<div id="frame" style="width: 100%;margin: auto;position: relative; z-index: 1;">
          <iframe data-aa='2416442' src='//acceptable.a-ads.com/2416442/?size=Adaptive'
                            style='border:0; padding:0; width:70%; height:auto; overflow:hidden;display: block;margin: auto'></iframe>
        </div>`;
// Intervallo annunci: 10-12 messaggi (generazione casuale)
let AD_INTERVAL = Math.floor(Math.random() * (12 - 10 + 1)) + 10; 

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const messagesRef = ref(db, "messages");
const usersRef = ref(db, "users");
const mutedUsersRef = ref(db, "mutedUsers");

let uid = localStorage.getItem("uid") || crypto.randomUUID();
localStorage.setItem("uid", uid);

let username = localStorage.getItem("username");
let isAdmin = localStorage.getItem("isAdmin") === "true"; 
let replyingTo = null; 
let isMuted = false;
let muteEndTime = 0;
let muteInterval = null;

// Variabile per tracciare il conteggio dei messaggi in JS (non persistente su DB)
let messageCount = 0; 

// New elements for mute feature
const inputBar = document.getElementById("inputBar");
const mutedNav = document.getElementById("mutedNav");

const nameModal = document.getElementById("nameModal");
const nameInput = document.getElementById("nameInput");
const saveNameBtn = document.getElementById("saveNameBtn");
const settingsBtn = document.getElementById("settingsBtn");

// Elements for admin feature
const adminBtn = document.getElementById("adminBtn");
const adminLoginModal = document.getElementById("adminLoginModal");
const adminPanelModal = document.getElementById("adminPanelModal");
const adminUser = document.getElementById("adminUser");
const adminPass = document.getElementById("adminPass");
const loginAdminBtn = document.getElementById("loginAdminBtn");
const adminLoginError = document.getElementById("adminLoginError");
const chatStyleSelect = document.getElementById("chatStyleSelect");
const adminTagSelect = document.getElementById("adminTagSelect");
const saveAdminSettingsBtn = document.getElementById("saveAdminSettingsBtn");
const removeAllBtn = document.getElementById("removeAllBtn"); 

// Elements for reply feature
const replyPreview = document.getElementById("replyPreview");
const replyInfo = document.getElementById("replyInfo");
const replyCancelBtn = document.getElementById("replyCancelBtn");


function updateAdminButton() {
  if (isAdmin) {
    adminBtn.textContent = "Admin Panel";
    adminBtn.onclick = showAdminPanel;
  } else {
    adminBtn.textContent = "Become Admin";
    adminBtn.onclick = showAdminLoginModal;
  }
}

// Function to send a bot notification message (uses 'text' for content)
function sendBotNotification(text) {
    push(messagesRef, {
        text: text,
        uid: BOT_UID,
        username: BOT_NAME,
        adminTag: BOT_TAG,
        created: Date.now()
    });
}

// Function to send the Ad message (uses 'html' for content)
function sendAdMessage() {
    push(messagesRef, {
        html: AD_HTML, // Use 'html' property for ad content
        uid: BOT_UID,
        username: BOT_NAME,
        adminTag: BOT_TAG,
        created: Date.now()
    });
}


function showNameModal() {
  nameModal.style.display = "flex";
  nameInput.value = username || "";
  nameInput.focus();
}

function showAdminLoginModal() {
  adminLoginError.style.display = "none";
  adminUser.value = "";
  adminPass.value = "";
  adminLoginModal.style.display = "flex";
  adminUser.focus();
}

function showAdminPanel() {
  const style = localStorage.getItem("chatStyle") || "normal";
  const tag = localStorage.getItem("adminTag") || "none";
  
  chatStyleSelect.value = style;
  adminTagSelect.value = tag;

  adminPanelModal.style.display = "flex";
}

if (!username) showNameModal();
updateAdminButton(); 

saveNameBtn.onclick = () => {
  const newName = nameInput.value.trim();
  if (!newName) return;
  
  const oldName = username;

  // Bot notification for name change
  if (oldName && newName !== oldName) {
      sendBotNotification(`User ${oldName} changed name to ${newName}.`);
  }

  username = newName;
  localStorage.setItem("username", newName);
  nameModal.style.display = "none";
};

settingsBtn.onclick = showNameModal;

// Admin login logic
loginAdminBtn.onclick = () => {
  const user = adminUser.value.trim();
  const pass = adminPass.value.trim();
  
  if (ADMIN_CREDENTIALS[user] === pass) {
    isAdmin = true;
    localStorage.setItem("isAdmin", "true");
    adminLoginModal.style.display = "none";
    updateAdminButton();
    showAdminPanel();
    update(ref(db, `users/${uid}`), { isAdmin: true, username: username });
  } else {
    adminLoginError.style.display = "block";
  }
};

// Admin panel save logic
saveAdminSettingsBtn.onclick = () => {
  const style = chatStyleSelect.value;
  const tag = adminTagSelect.value;

  localStorage.setItem("chatStyle", style);
  localStorage.setItem("adminTag", tag);
  
  update(ref(db, `users/${uid}`), { chatStyle: style, adminTag: tag, username: username });

  adminPanelModal.style.display = "none";
};

// Admin Action: Remove All Messages
removeAllBtn.onclick = () => {
  if (confirm("ARE YOU SURE YOU WANT TO REMOVE ALL MESSAGES? This cannot be undone.")) {
    remove(messagesRef)
      .then(() => {
        alert("All messages removed successfully!");
        adminPanelModal.style.display = "none";
      })
      .catch(error => {
        alert("Error removing messages: " + error.message);
      });
  }
};

const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const messagesBox = document.getElementById("messages");

// Reply feature functions
function setReply(msgKey, username, text, targetUid) {
    replyingTo = { key: msgKey, username, text, targetUid }; 
    replyInfo.innerHTML = `<strong>${username}</strong> ${text}`;
    replyPreview.style.display = "flex";
    msgInput.focus();
}

function cancelReply() {
    replyingTo = null;
    replyPreview.style.display = "none";
}

replyCancelBtn.onclick = cancelReply;


function parseMuteTime(timeStr) {
    const timeValue = parseInt(timeStr.slice(0, -1));
    const timeUnit = timeStr.slice(-1).toLowerCase();
    
    if (isNaN(timeValue)) return 0;

    let milliseconds = 0;
    if (timeUnit === 'm') {
        milliseconds = timeValue * 60 * 1000;
    } else if (timeUnit === 'h') {
        milliseconds = timeValue * 60 * 60 * 1000;
    } else if (timeUnit === 'd') {
        milliseconds = timeValue * 24 * 60 * 60 * 1000;
    }
    return milliseconds;
}


function processAdminCommand(text) {
    const parts = text.toLowerCase().split(' ');
    const command = parts[0];
    const targetUid = replyingTo?.targetUid;
    const targetUsername = replyingTo?.username;
    
    if (!targetUid) {
        alert("Admin command must be a reply to a message.");
        return true; 
    }

    if (command === '/mute') {
        const timeStr = parts[1];
        if (!timeStr) {
            alert("Usage: /mute <time> (e.g., /mute 30m, /mute 1h, /mute 7d)");
            return true;
        }

        const muteDuration = parseMuteTime(timeStr);
        if (muteDuration > 0) {
            const end = Date.now() + muteDuration;
            set(ref(db, `mutedUsers/${targetUid}`), {
                mutedUntil: end,
                adminUid: uid,
                adminUsername: username,
                targetUsername: targetUsername 
            });
            // Bot notification
            sendBotNotification(`${username} has muted ${targetUsername}.`);
        } else {
            alert("Invalid mute time format.");
        }
        return true;
    } else if (command === '/unmute') { 
        // Unmute command
        remove(ref(db, `mutedUsers/${targetUid}`));
        // Bot notification
        sendBotNotification(`${username} has unmuted ${targetUsername}.`);
        return true;
    }
    
    return false; // Not an admin command
}

function sendMessage() {
  if (!username) return showNameModal();
  if (isMuted) return; 

  const text = msgInput.value.trim();
  if (!text) return;
  
  // Check for and execute admin commands
  if (isAdmin && replyingTo) {
      if (processAdminCommand(text)) {
          msgInput.value = "";
          cancelReply();
          return;
      }
  }

  // Regular message logic
  const chatStyle = localStorage.getItem("chatStyle") || "normal";
  const adminTag = localStorage.getItem("adminTag") || "none";

  const messageData = { 
    text, 
    uid, 
    username, 
    created: Date.now(),
    chatStyle: isAdmin ? chatStyle : "normal", 
    adminTag: isAdmin ? adminTag : "none"
  };

  if (replyingTo) {
    messageData.replyToKey = replyingTo.key;
    messageData.replyToUser = replyingTo.username;
    messageData.replyToText = replyingTo.text;
    cancelReply(); 
  }

  push(messagesRef, messageData);
  msgInput.value = "";
}

sendBtn.onclick = sendMessage;
msgInput.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });


// Mute Status Observer & Updater
onValue(mutedUsersRef, snapshot => {
    const mutedData = snapshot.val();
    const myMute = mutedData ? mutedData[uid] : null;
    const now = Date.now();

    if (myMute && myMute.mutedUntil > now) {
        isMuted = true;
        muteEndTime = myMute.mutedUntil;
        inputBar.classList.add('muted');
        
        if (muteInterval) clearInterval(muteInterval);
        
        muteInterval = setInterval(() => {
            const remaining = muteEndTime - Date.now();
            if (remaining <= 0) {
                isMuted = false;
                inputBar.classList.remove('muted');
                mutedNav.textContent = '';
                clearInterval(muteInterval);
                remove(ref(db, `mutedUsers/${uid}`)); 
            } else {
                const seconds = Math.floor(remaining / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const displayTime = `${hours % 24}h ${minutes % 60}m ${seconds % 60}s`;
                mutedNav.innerHTML = `You are muted. Time remaining: ${displayTime}`;
            }
        }, 1000);

    } else {
        isMuted = false;
        muteEndTime = 0;
        inputBar.classList.remove('muted');
        mutedNav.textContent = '';
        if (muteInterval) clearInterval(muteInterval);
        
        if (myMute && myMute.mutedUntil <= now) {
             remove(ref(db, `mutedUsers/${uid}`));
        }
    }
});


onValue(messagesRef, snapshot => {
  const data = snapshot.val();
  messagesBox.innerHTML = "";
  messageCount = 0; // Reset count per render

  if (data) {
    const allMessages = Object.keys(data) 
      .map(key => ({ key, ...data[key] }))
      .sort((a,b) => a.created - b.created);

    // Variabile per mantenere lo stato di iniezione dell'ad attraverso il rendering
    let injectedAds = 0; 

    allMessages.forEach(d => {
        // Conta solo i messaggi utente e le notifiche bot non-ad
        if (d.uid !== BOT_UID || d.text) {
            messageCount++;
        }

        const wrap = document.createElement("div");
        wrap.className = "bubble " + (d.uid === uid ? "me" : "them");
        wrap.dataset.msgKey = d.key; 

        // New: Reply click handler (simulates swipe) - only attach if not a bot message or ad
        if (d.uid !== BOT_UID && !d.html) {
            wrap.addEventListener('click', () => {
                setReply(d.key, d.username, d.text, d.uid); 
            });
        }

        // Add reply container if message is a reply
        if (d.replyToKey) {
            const replyDiv = document.createElement("div");
            replyDiv.className = "reply-container";
            replyDiv.innerHTML = `<strong>${d.replyToUser}</strong> ${d.replyToText}`;
            wrap.appendChild(replyDiv);
        }

        const nameDiv = document.createElement("div");
        nameDiv.className = "name";
        nameDiv.textContent = d.username || "Unknown";
        
        // Add Tag
        if (d.adminTag && d.adminTag !== "none") {
          const tagSpan = document.createElement("span");
          // Use 'tag-system' for the bot, 'tag-admin' or 'tag-mod' for others
          tagSpan.className = `admin-tag tag-${d.adminTag === BOT_TAG ? 'system' : d.adminTag}`;
          tagSpan.textContent = d.adminTag.toUpperCase();
          nameDiv.appendChild(tagSpan);
        }

        wrap.appendChild(nameDiv);

        const contentNode = document.createElement("div");
        
        // Check if message contains HTML (e.g., the Ad)
        if (d.html) {
            // Se Ã¨ un annuncio salvato nel DB, lo visualizza
            contentNode.innerHTML = d.html; 
        } else {
            contentNode.textContent = d.text || ""; // Insert plain text
        }
        
        // Apply Gold Text Style
        if (d.chatStyle === 'gold') {
          contentNode.classList.add('gold-text');
        }

        wrap.appendChild(contentNode);
        messagesBox.appendChild(wrap);

        // --- Ad Insertion Logic (per l'iniezione dinamica) ---
        // Se il conteggio raggiunge l'intervallo, inserisce l'annuncio
        if (messageCount % AD_INTERVAL === 0 && d.uid !== BOT_UID && !d.html && messageCount > (injectedAds * AD_INTERVAL)) {
             
             injectedAds++; // Traccia l'iniezione

             // Crea un bubble per l'annuncio
             const adWrap = document.createElement("div");
             adWrap.className = "bubble them"; 

             const adNameDiv = document.createElement("div");
             adNameDiv.className = "name";
             adNameDiv.textContent = BOT_NAME;
             
             const adTagSpan = document.createElement("span");
             adTagSpan.className = `admin-tag tag-system`;
             adTagSpan.textContent = BOT_TAG.toUpperCase();
             adNameDiv.appendChild(adTagSpan);

             const adContentNode = document.createElement("div");
             adContentNode.innerHTML = AD_HTML;
             
             adWrap.appendChild(adNameDiv);
             adWrap.appendChild(adContentNode);
             messagesBox.appendChild(adWrap);
             
             messageCount++; // Incrementa il conteggio per l'annuncio inserito dinamicamente
             
             // Re-calcola il prossimo intervallo casuale 10-12
             AD_INTERVAL = Math.floor(Math.random() * (12 - 10 + 1)) + 10;
        }
    });
  }
  messagesBox.scrollTop = messagesBox.scrollHeight;
});

// theme toggle
const toggle = document.getElementById("themeToggle");
toggle.onclick = () => {
  const dark = document.body.dataset.theme === "dark";
  document.body.dataset.theme = dark ? "" : "dark";
  localStorage.setItem("theme", dark ? "light" : "dark");
};
if (localStorage.getItem("theme") === "dark") document.body.dataset.theme = "dark";
</script>

</body>
</html>
